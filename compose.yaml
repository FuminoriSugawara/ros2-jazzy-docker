x-ros-common: &ros-common
  stdin_open: true
  tty: true
  command: bash
  environment:
    - ROS_DISTRO=jazzy
  volumes:
    - .:/workspaces/ros2
  working_dir: /workspaces/ros2

services:
  dev:
    <<: *ros-common
    image: ros2-jazzy-dev
    build:
      context: .
      dockerfile: Dockerfile

  rosbag2:
    <<: *ros-common
    image: ros2-jazzy-rosbag2
    build:
      context: .
      dockerfile: Dockerfile.rosbag2
      args:
        BASE_IMAGE: ros2-jazzy-dev

  realsense:
    <<: *ros-common
    image: ros2-jazzy-realsense
    build:
      context: .
      dockerfile: Dockerfile.realsense
      args:
        BASE_IMAGE: ros2-jazzy-dev
    devices:
      - /dev/bus/usb:/dev/bus/usb
    privileged: true

  realsense-yolo:
    <<: *ros-common
    image: ros2-jazzy-realsense-yolo
    build:
      context: .
      dockerfile: Dockerfile.realsense-yolo
      args:
        BASE_IMAGE: ros2-jazzy-realsense
    devices:
      - /dev/bus/usb:/dev/bus/usb
    privileged: true

  zenoh-bridge:
    <<: *ros-common
    image: ros2-jazzy-zenoh-bridge
    build:
      context: .
      dockerfile: Dockerfile.zenoh-bridge
      args:
        BASE_IMAGE: ros2-jazzy-dev
    environment:
      - ZENOH_CONFIG=/etc/zenoh/bridge.json
      - ZENOH_CONNECT=${ZENOH_CONNECT:-}
    command:
      - bash
      - -lc
      - |
        : "$${ZENOH_CONNECT:?Set ZENOH_CONNECT in .env (e.g., tcp/host:7447)}"
        envsubst < /etc/zenoh/bridge.json > /tmp/bridge.rendered.json
        exec zenoh-bridge-dds --config /tmp/bridge.rendered.json
    volumes:
      - ./zenoh-bridge-config:/etc/zenoh

  zenohd:
    image: zenohd
    build:
      context: .
      dockerfile: Dockerfile.zenohd
    ports:
      - "7447:7447/tcp"
      - "7446:7446/udp"
    volumes:
      - ./zenohd-config:/etc/zenoh
      - zenoh-data:/var/lib/zenoh
    restart: unless-stopped

volumes:
  zenoh-data:
